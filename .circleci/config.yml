version: 2.1

commands:
  destroy_environment:
    steps:
      - run:
          name: Destroy environment
          command: |
            aws cloudformation delete-stack --stack-name network-stack
            aws cloudformation delete-stack --stack-name backend-stack
            aws cloudformation delete-stack --stack-name cloudfront-stack
            aws cloudformation delete-stack --stack-name frontend-stack

jobs:
  create_infrastructure:
      docker:
        - image: amazon/aws-cli
      steps:
        - checkout
        - run:
            name: Deploys the Network 
            command: |
              cd files
              aws cloudformation deploy \
                --template-file network.yml \
                --stack-name network-stack 
        - run:
            name: Deploys the Backend
            command: |
              cd files
              aws cloudformation deploy \
                --template-file backend.yml \
                --stack-name backend-stack
        - run:
            name: Deploys the Cloudfront
            command: |
              cd files
              aws cloudformation deploy \
                --template-file cloudfront.yml \
                --stack-name cloudfront-stack
        - run:
            name: Deploys the Frontend
            command: |
              cd files
              aws cloudformation deploy \
                --template-file frontend.yml \
                --stack-name frontend-stack
        - destroy_environment:
            when: on_fail

workflows:
  build-test-and-approval-deploys:
      - create_infrastructure